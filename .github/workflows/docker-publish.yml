name: Build and Deploy Services

on:
  push: 
    branches: ['devops']
    paths:
      - 'cybrid-backend/**'  
      - 'cybrid-txn/**'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2 
      - name: Create SSH key file
        run: |
          echo "${{ secrets.SSH_KEY }}" > /tmp/private_key
          chmod 600 /tmp/private_key
          echo /tmp/private_key
          cat /tmp/private_key

      # Input parameters (with default values)
      - name: Set input defaults
        run: |
          echo "cybrid_backend_input=false" >> $GITHUB_ENV
          echo "cybrid_txn_input=false" >> $GITHUB_ENV

      # Check if input variables are passed
      - name: Set inputs from action
        run: |
          echo "cybrid_backend_input=${{ github.event.inputs.cybrid-backend || 'false' }}" >> $GITHUB_ENV
          echo "cybrid_txn_input=${{ github.event.inputs.cybrid-txn || 'false' }}" >> $GITHUB_ENV

      # Determine which services to build and deploy
      - name: Set services to build
        run: |
          echo "CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)" >> $GITHUB_ENV
          if echo "$CHANGED_FILES" | grep -q '^cybrid-backend/'; then
            echo "cybrid_backend=true" >> $GITHUB_ENV
          else
            echo "cybrid_backend=false" >> $GITHUB_ENV
          fi
          
          if echo "$CHANGED_FILES" | grep -q '^cybrid-txn/'; then
            echo "cybrid_txn=true" >> $GITHUB_ENV
          else
            echo "cybrid_txn=false" >> $GITHUB_ENV
          fi

      # Log the changed files (for debugging)
      - name: Log changed files
        run: echo "Changed files ${{ env.CHANGED_FILES }}"

      # Conditionally build and deploy cybrid Backend
      - name: Build and deploy cybrid Backend 
        if: env.cybrid_backend == 'true'
        run: echo "Building and deploying cybrid Backend service"
       
      # Conditionally build and deploy cybrid txn
      - name: Build and deploy cybrid txn
        if: env.cybrid_txn == 'true'
        run: echo "Building and deploying cybrid txn service"
